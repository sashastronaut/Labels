<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Генератор QR-кодов с рамкой</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #333;
        }
        
        .section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .section-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #555;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: inline-block;
            width: 250px;
            margin-right: 10px;
        }
        
        input[type="text"], input[type="number"], select {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
            width: 100px;
        }
        
        input[type="file"] {
            padding: 5px;
        }
        
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        button.secondary {
            background-color: #2196F3;
        }
        
        button.secondary:hover {
            background-color: #1976D2;
        }
        
        .hidden {
            display: none;
        }
        
        .image-container {
            display: block;
            margin-top: 20px;
        }
        
        .image-box {
            display: block;
            text-align: center;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .image-box img {
            max-width: 100%;
            max-height: 300px;
        }
        
        canvas {
            border: 1px solid #ccc;
            max-width: 100%;
        }
        
        #qrCanvas {
            position: absolute;
            border: 2px dashed red;
            cursor: move;
            display: none;
            z-index: 1000; /* Ensure it stays on top */
            pointer-events: auto; /* Make sure it receives mouse events */
        }
        
        #serialRangeInput {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        #customSizeFields {
            margin-left: 20px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Генератор QR-кодов с рамкой</h1>
        
        <!-- Section 1: Размеры изображения -->
        <div class="section">
            <div class="section-title">1. Размеры итогового изображения</div>
            <div class="form-group">
                <label for="imgWidth">Ширина изображения (мм):</label>
                <input type="number" id="imgWidth" min="1" value="55">
            </div>
            <div class="form-group">
                <label for="imgHeight">Высота изображения (мм):</label>
                <input type="number" id="imgHeight" min="1" value="10">
            </div>
        </div>
        
        <!-- Section 2: QR-код -->
        <div class="section">
            <div class="section-title">2. QR-код</div>
            <div class="form-group">
                <label for="qrWidth">Ширина QR-кода (мм):</label>
                <input type="number" id="qrWidth" min="1" value="8">
            </div>
            <div class="form-group">
                <label for="qrHeight">Высота QR-кода (мм):</label>
                <input type="number" id="qrHeight" min="1" value="8">
            </div>
        </div>
        
        <!-- Section 3: Серийные номера -->
        <div class="section">
            <div class="section-title">3. Серийные номера</div>
            <div class="form-group">
                <div id="serialRangeInput">
                    <label>Диапазон серийных номеров:</label>
                    <span>С</span>
                    <input type="number" id="startSerial" min="1" value="10001000001">
                    <span>По</span>
                    <input type="number" id="endSerial" min="1" value="10001000005">
                </div>
            </div>
        </div>
        
        <!-- Section 4: Результаты -->
        <div class="section">
            <div class="section-title">4. Результаты генерации</div>
            <div class="form-group">
                <button id="generateBtn">Сгенерировать изображения с QR-кодами</button>
            </div>
            <div class="image-container">
                <div class="image-box">
                    <h3>Масштабированное изображение</h3>
                    <canvas id="scaledCanvas"></canvas>
                </div>
                <div class="image-box">
                    <h3>Итоговое изображение с QR-кодом</h3>
                    <canvas id="resultCanvas"></canvas>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button id="downloadImagesBtn">Скачать все изображения</button>
            </div>
        </div>
        
        <!-- Canvas для QR-кода -->
        <canvas id="qrCanvas" width="100" height="100"></canvas>
    </div>

    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/master/qrcode.min.js"></script>
    <script>
        // Основные переменные
        let scaledImage = null;
        let qrCodePosition = { x: 0.1, y: 0.1 }; // Позиция QR-кода как доля от размера изображения
        let generatedImages = [];
        
        // DOM элементы
        const imgWidthInput = document.getElementById('imgWidth');
        const imgHeightInput = document.getElementById('imgHeight');
        const qrWidthInput = document.getElementById('qrWidth');
        const qrHeightInput = document.getElementById('qrHeight');
        const startSerialInput = document.getElementById('startSerial');
        const endSerialInput = document.getElementById('endSerial');
        const generateBtn = document.getElementById('generateBtn');
        const downloadImagesBtn = document.getElementById('downloadImagesBtn');
        const scaledCanvas = document.getElementById('scaledCanvas');
        const resultCanvas = document.getElementById('resultCanvas');
        const qrCanvas = document.getElementById('qrCanvas');
        
        // Обработчики событий
        generateBtn.addEventListener('click', generateAllImages);
        downloadImagesBtn.addEventListener('click', downloadAllImages);
        
        // Инициализация
        initializeApp();
        
        function initializeApp() {
            // Устанавливаем начальные размеры холстов
            scaledCanvas.width = 550; // 55mm * 10px/mm
            scaledCanvas.height = 100; // 10mm * 10px/mm
            resultCanvas.width = 550; // 55mm * 10px/mm
            resultCanvas.height = 100; // 10mm * 10px/mm
            
            // Рисуем пример на холстах
            drawPlaceholder(scaledCanvas, "Масштабированное изображение");
            drawPlaceholder(resultCanvas, "Итоговое изображение с QR-кодом");
        }
        
        function drawPlaceholder(canvas, text) {
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#f0f0f0';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.strokeStyle = '#ccc';
            ctx.lineWidth = 1;
            ctx.strokeRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = '#999';
            ctx.font = '14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(text, canvas.width/2, canvas.height/2);
        }
        
        function generateAllImages() {
            const imgWidth = parseFloat(imgWidthInput.value);
            const imgHeight = parseFloat(imgHeightInput.value);
            const qrWidth = parseFloat(qrWidthInput.value);
            const qrHeight = parseFloat(qrHeightInput.value);
            const startSerial = parseInt(startSerialInput.value);
            const endSerial = parseInt(endSerialInput.value);
            
            // Проверяем, что QR-код помещается внутри изображения
            if (qrWidth > imgWidth || qrHeight > imgHeight) {
                alert("Размер QR-кода больше размера изображения! QR-код должен быть меньше или равен размеру изображения.");
                return;
            }
            
            // Проверяем корректность диапазона серийных номеров
            if (isNaN(startSerial) || isNaN(endSerial) || startSerial > endSerial) {
                alert("Некорректный диапазон серийных номеров!");
                return;
            }
            
            // Создаем масштабированное изображение
            createScaledImage(imgWidth, imgHeight);
            
            // Генерируем изображения для каждого серийного номера
            generatedImages = [];
            for (let serial = startSerial; serial <= endSerial; serial++) {
                const imageData = generateSingleImageWithQR(imgWidth, imgHeight, qrWidth, qrHeight, serial);
                generatedImages.push({
                    serial: serial,
                    data: imageData
                });
            }
            
            // Отображаем первое изображение в результатах
            if (generatedImages.length > 0) {
                const ctx = resultCanvas.getContext('2d');
                const img = new Image();
                img.onload = function() {
                    ctx.clearRect(0, 0, resultCanvas.width, resultCanvas.height);
                    ctx.drawImage(img, 0, 0, resultCanvas.width, resultCanvas.height);
                };
                img.src = generatedImages[0].data;
            }
            
            console.log(`Сгенерировано ${generatedImages.length} изображений`);
        }
        
        function createScaledImage(width, height) {
            // Создаем масштабированное изображение
            const pxPerMm = 10; // 10 пикселей на миллиметр для наглядности
            const canvas = document.createElement('canvas');
            canvas.width = width * pxPerMm;
            canvas.height = height * pxPerMm;
            const ctx = canvas.getContext('2d');
            
            // Рисуем фон (белый прямоугольник)
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Рисуем границу
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            ctx.strokeRect(0, 0, canvas.width, canvas.height);
            
            // Добавляем текст с размерами
            ctx.fillStyle = '#666';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`${width}x${height} мм`, canvas.width/2, canvas.height/2);
            
            scaledImage = new Image();
            scaledImage.src = canvas.toDataURL();
            
            // Обновляем отображение масштабированного изображения
            const scaledCtx = scaledCanvas.getContext('2d');
            scaledCtx.clearRect(0, 0, scaledCanvas.width, scaledCanvas.height);
            scaledCtx.drawImage(scaledImage, 0, 0, scaledCanvas.width, scaledCanvas.height);
        }
        
        function generateSingleImageWithQR(imgWidth, imgHeight, qrWidth, qrHeight, serialNumber) {
            const pxPerMm = 10; // 10 пикселей на миллиметр для наглядности
            const canvas = document.createElement('canvas');
            canvas.width = imgWidth * pxPerMm;
            canvas.height = imgHeight * pxPerMm;
            const ctx = canvas.getContext('2d');
            
            // Рисуем фон (белый прямоугольник)
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Рисуем границу
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            ctx.strokeRect(0, 0, canvas.width, canvas.height);
            
            // Создаем QR-код
            const qrCanvas = document.createElement('canvas');
            const qrSize = Math.min(qrWidth * pxPerMm, qrHeight * pxPerMm);
            qrCanvas.width = qrSize;
            qrCanvas.height = qrSize;
            const qrCtx = qrCanvas.getContext('2d');
            
            // Рисуем простой QR-код (симуляция)
            qrCtx.fillStyle = 'white';
            qrCtx.fillRect(0, 0, qrCanvas.width, qrCanvas.height);
            
            // Позиционные маркеры
            drawQRPattern(qrCtx, 0, 0, qrSize/3);
            drawQRPattern(qrCanvas.width - qrSize/3, 0, qrSize/3);
            drawQRPattern(0, qrCanvas.height - qrSize/3, qrSize/3);
            
            // Внутренние данные (упрощенная симуляция)
            for (let i = 0; i < 5; i++) {
                for (let j = 0; j < 5; j++) {
                    if ((i + j + serialNumber) % 3 === 0) {
                        qrCtx.fillStyle = 'black';
                        qrCtx.fillRect(
                            (qrSize/3) + i * (qrSize/7),
                            (qrSize/3) + j * (qrSize/7),
                            qrSize/10,
                            qrSize/10
                        );
                    }
                }
            }
            
            // Текст с серийным номером в QR-коде
            qrCtx.fillStyle = 'black';
            qrCtx.font = `${qrSize/8}px Arial`;
            qrCtx.textAlign = 'center';
            qrCtx.fillText(serialNumber.toString(), qrCanvas.width/2, qrCanvas.height/2);
            
            // Вычисляем позицию QR-кода внутри изображения
            // QR-код должен быть строго внутри, с отступом от краев
            const margin = 2 * pxPerMm; // Минимальный отступ 2 мм
            const maxX = canvas.width - qrCanvas.width - margin;
            const maxY = canvas.height - qrCanvas.height - margin;
            
            // Позиция QR-кода (например, в правом верхнем углу с отступом)
            const qrX = Math.min(maxX, margin);
            const qrY = Math.min(maxY, margin);
            
            // Рисуем QR-код на основном изображении
            ctx.drawImage(qrCanvas, qrX, qrY);
            
            // Добавляем текст с серийным номером на изображении
            ctx.fillStyle = '#333';
            ctx.font = '12px Arial';
            ctx.textAlign = 'left';
            ctx.fillText(`SN: ${serialNumber}`, 5, 15);
            
            return canvas.toDataURL();
        }
        
        // Функция для рисования позиционных маркеров QR-кода
        function drawQRPattern(ctx, x, y, size) {
            // Внешний квадрат (черный)
            ctx.fillStyle = 'black';
            ctx.fillRect(x, y, size, size);
            
            // Внутренний квадрат (белый)
            const innerSize = size * 0.6;
            ctx.fillStyle = 'white';
            ctx.fillRect(
                x + size * 0.2, 
                y + size * 0.2, 
                innerSize, 
                innerSize
            );
        }
        
        function downloadAllImages() {
            if (generatedImages.length === 0) {
                alert("Сначала сгенерируйте изображения!");
                return;
            }
            
            // В реальной реализации мы бы создали ZIP-архив
            // Для простоты сейчас просто откроем каждое изображение в новой вкладке
            for (let i = 0; i < generatedImages.length; i++) {
                const link = document.createElement('a');
                link.href = generatedImages[i].data;
                link.download = `qr_image_${generatedImages[i].serial}.png`;
                
                // Открываем ссылку программно
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
    </script>
</body>
</html>